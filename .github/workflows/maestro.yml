name: Maestro UI Tests

# Workflow runs on all branches but Maestro tests only run on: main, dev, project-foundation
# On other branches: builds and unit tests run, Maestro tests are skipped

on:
  push:
    # Run on all branches
  pull_request:
    # Run on all branches
  workflow_dispatch:  # Allow manual trigger
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - auth
          - navigation
          - payment

permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  maestro-ios:
    name: Maestro iOS Tests
    runs-on: macos-15  # macOS 15 has Xcode 16.1+ required by React Native
    timeout-minutes: 45
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
      
      - name: Verify Maestro installation
        run: maestro --version
      
      - name: Setup iOS Simulator
        run: |
          # List available simulators and runtimes
          echo "Available simulators:"
          xcrun simctl list devices available
          echo "Available runtimes:"
          xcrun simctl list runtimes
          
          # Use stable iOS 18.x runtime (avoid beta versions like iOS 26)
          RUNTIME=$(xcrun simctl list runtimes | grep "iOS 18" | tail -1 | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.[^ ]+')
          
          if [ -z "$RUNTIME" ]; then
            echo "iOS 18 not found, falling back to latest iOS runtime"
            RUNTIME=$(xcrun simctl list runtimes | grep "iOS" | grep -v "26.0" | tail -1 | grep -oE 'com\.apple\.CoreSimulator\.SimRuntime\.[^ ]+' || echo "iOS")
          fi
          
          echo "Using runtime: $RUNTIME"
          
          # Try to find existing Maestro-iPhone-15 first
          DEVICE_ID=$(xcrun simctl list devices | grep "Maestro-iPhone-15" | grep -oE '\([A-F0-9-]+\)' | tr -d '()' | head -1)
          
          # If not found, create new one
          if [ -z "$DEVICE_ID" ]; then
            echo "Creating new Maestro-iPhone-15 simulator..."
            DEVICE_ID=$(xcrun simctl create "Maestro-iPhone-15" com.apple.CoreSimulator.SimDeviceType.iPhone-15 "$RUNTIME" 2>&1)
            
            if [ $? -ne 0 ]; then
              echo "Failed to create simulator, trying to find any iPhone 15..."
              DEVICE_ID=$(xcrun simctl list devices | grep "iPhone 15" | grep "Booted\|Shutdown" | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
            fi
          else
            echo "Found existing Maestro-iPhone-15 simulator"
          fi
          
          if [ -z "$DEVICE_ID" ]; then
            echo "Error: Could not create or find simulator"
            exit 1
          fi
          
          echo "Device ID: $DEVICE_ID"
          echo "SIMULATOR_ID=$DEVICE_ID" >> $GITHUB_ENV
          
          # Boot simulator
          echo "Booting simulator..."
          xcrun simctl boot "$DEVICE_ID" 2>&1 || echo "Simulator may already be booted"
          
          # Wait for simulator to boot (bootstatus blocks until ready)
          echo "Waiting for simulator to boot..."
          xcrun simctl bootstatus "$DEVICE_ID" -b
          echo "Simulator booted successfully!"
      
      - name: Prebuild iOS app
        run: npx expo prebuild --platform ios --clean
      
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install
      
      - name: Build iOS app for simulator
        run: |
          cd ios
          
          # List contents to debug
          echo "Contents of ios directory:"
          ls -la
          
          # Find workspace (use -d flag to only find directories)
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -1 | sed 's|^\./||')
          
          if [ -z "$WORKSPACE" ]; then
            echo "Error: No .xcworkspace found"
            exit 1
          fi
          
          echo "Found workspace: $WORKSPACE"
          
          # List available schemes
          echo "Listing schemes in workspace:"
          xcodebuild -workspace "$WORKSPACE" -list
          
          # Get scheme from workspace (first non-Pods scheme)
          SCHEME=$(xcodebuild -workspace "$WORKSPACE" -list 2>/dev/null | sed -n '/Schemes:/,/^$/p' | grep -v "Schemes:" | grep -v "Pods" | grep -v "^$" | head -1 | xargs)
          
          if [ -z "$SCHEME" ]; then
            # Fallback: use workspace name without extension
            SCHEME="${WORKSPACE%.xcworkspace}"
            echo "No scheme found in list, using fallback: $SCHEME"
          else
            echo "Found scheme: $SCHEME"
          fi
          
          echo "Building with workspace: $WORKSPACE and scheme: $SCHEME"
          echo "Target simulator ID: $SIMULATOR_ID"
          
          # Build for the specific simulator we created
          xcodebuild \
            -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Debug \
            -sdk iphonesimulator \
            -derivedDataPath build \
            -destination "platform=iOS Simulator,id=$SIMULATOR_ID" \
            CODE_SIGNING_ALLOWED=NO \
            COMPILER_INDEX_STORE_ENABLE=NO
      
      - name: Install app on simulator
        run: |
          APP_PATH=$(find ios/build/Build/Products/Debug-iphonesimulator -name "*.app" -type d | head -1)
          echo "Installing app from: $APP_PATH"
          echo "Installing to simulator: $SIMULATOR_ID"
          
          xcrun simctl install "$SIMULATOR_ID" "$APP_PATH"
          
          # Launch the app
          BUNDLE_ID=$(defaults read "$APP_PATH/Info.plist" CFBundleIdentifier)
          echo "Launching app with bundle ID: $BUNDLE_ID"
          xcrun simctl launch "$SIMULATOR_ID" "$BUNDLE_ID"
          sleep 3
      
      - name: Run Maestro tests - Auth flows
        if: (contains(fromJSON('["main", "dev", "project-foundation"]'), github.ref_name) || github.event_name == 'workflow_dispatch') && (github.event.inputs.test_suite == 'auth' || github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '')
        run: |
          maestro test .maestro/flows/auth/ \
            --format junit \
            --output maestro-results-auth.xml
        continue-on-error: true
      
      - name: Run Maestro tests - Navigation flows
        if: (contains(fromJSON('["main", "dev", "project-foundation"]'), github.ref_name) || github.event_name == 'workflow_dispatch') && (github.event.inputs.test_suite == 'navigation' || github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '')
        run: |
          maestro test .maestro/flows/navigation/ \
            --format junit \
            --output maestro-results-navigation.xml
        continue-on-error: true
      
      - name: Run Maestro tests - Payment flows
        if: (contains(fromJSON('["main", "dev", "project-foundation"]'), github.ref_name) || github.event_name == 'workflow_dispatch') && (github.event.inputs.test_suite == 'payment' || github.event.inputs.test_suite == 'all' || github.event.inputs.test_suite == '')
        run: |
          maestro test .maestro/flows/payment/ \
            --format junit \
            --output maestro-results-payment.xml
        continue-on-error: true
      
      - name: Create empty results if tests didn't run
        if: always()
        run: |
          # Create empty result file if no test results exist
          if ! ls maestro-results-*.xml 1> /dev/null 2>&1; then
            echo '<?xml version="1.0" encoding="UTF-8"?><testsuites><testsuite name="Maestro iOS" tests="0" skipped="0" failures="0" errors="0"></testsuite></testsuites>' > maestro-results-empty.xml
            echo "No test results found, created empty result file"
          else
            echo "Test result files found:"
            ls -la maestro-results-*.xml
          fi
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maestro-ios-results
          path: |
            maestro-results-*.xml
            ~/.maestro/tests/**/*.png
            ~/.maestro/tests/**/*.mp4
          if-no-files-found: warn
          retention-days: 30
      
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action/macos@v2
        if: always()
        with:
          files: 'maestro-results-*.xml'
          check_name: 'Maestro iOS Test Results'

  maestro-android:
    name: Maestro Android Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Free up disk space
        run: |
          echo "Disk space before cleanup:"
          df -h
          
          # Aggressive cleanup BEFORE installing build tools
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android/sdk/ndk
          sudo rm -rf /usr/local/lib/android/sdk/build-tools/*/
          sudo rm -rf /usr/share/swift
          sudo rm -rf /opt/az
          sudo docker image prune -a -f || true
          sudo apt-get clean
          
          echo "Disk space after cleanup:"
          df -h
      
      - name: Install dependencies
        run: npm ci --legacy-peer-deps
      
      - name: Install Maestro CLI
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$HOME/.maestro/bin:$PATH"
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Verify Java installation
        run: |
          echo "JAVA_HOME: $JAVA_HOME"
          echo "Java version:"
          java -version
          echo "Javac version:"
          javac -version
          ls -la "$JAVA_HOME"
      
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
      
      - name: Enable KVM for emulator
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm
      
      - name: AVD cache
        uses: actions/cache@v4
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-33-google-apis-x86_64-v3
      
      - name: Setup Gradle cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-
      
      - name: Prebuild Android app
        run: npx expo prebuild --platform android --clean
      
      - name: Build Android APK
        run: |
          cd android
          ./gradlew assembleDebug --no-daemon --max-workers=2
          
          # Clean up intermediate build files (keep the APK!)
          find . -type d -name "intermediates" -exec rm -rf {} + || true
          find . -type d -name ".cxx" -exec rm -rf {} + || true
          rm -rf ~/.gradle/caches/build-cache-* || true
          rm -rf ~/.gradle/caches/transforms-* || true
      
      - name: Check disk space before emulator
        run: |
          echo "Disk space before starting emulator:"
          df -h
          echo "Available space in root:"
          df -h / | tail -1 | awk '{print $4}'
      
      - name: Run Maestro tests on emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none -partition-size 2048
          disable-animations: true
          cores: 2
          ram-size: 2048M
          heap-size: 256M
          emulator-boot-timeout: 900
          script: |
            # Only run Maestro tests on specific branches
            BRANCH="${{ github.ref_name }}"
            EVENT="${{ github.event_name }}"
            echo "Branch: $BRANCH"
            echo "Event: $EVENT"
            
            if [ "$EVENT" != "workflow_dispatch" ] && [ "$BRANCH" != "main" ] && [ "$BRANCH" != "dev" ] && [ "$BRANCH" != "project-foundation" ]; then
              echo "Skipping Maestro tests on branch: $BRANCH"
              echo "Tests only run on: main, dev, project-foundation (or manual trigger)"
              exit 0
            fi
            
            echo "Running Maestro tests on branch: $BRANCH"
            
            # Install APK
            adb install android/app/build/outputs/apk/debug/app-debug.apk
            sleep 5
            
            # Run Maestro tests
            TEST_SUITE="${{ github.event.inputs.test_suite }}"
            
            # Auth tests
            if [ "$TEST_SUITE" = "auth" ] || [ -z "$TEST_SUITE" ]; then
              maestro test .maestro/flows/auth/ --format junit --output maestro-android-auth.xml || echo "Auth tests failed"
            fi
            
            # Navigation tests  
            if [ "$TEST_SUITE" = "navigation" ] || [ "$TEST_SUITE" = "all" ] || [ -z "$TEST_SUITE" ]; then
              maestro test .maestro/flows/navigation/ --format junit --output maestro-android-navigation.xml || echo "Navigation tests failed"
            fi
            
            # Payment tests
            if [ "$TEST_SUITE" = "payment" ] || [ "$TEST_SUITE" = "all" ] || [ -z "$TEST_SUITE" ]; then
              maestro test .maestro/flows/payment/ --format junit --output maestro-android-payment.xml || echo "Payment tests failed"
            fi
            
            # Create empty result if no tests ran
            ls maestro-android-*.xml >/dev/null 2>&1 || echo '<?xml version="1.0"?><testsuites></testsuites>' > maestro-android-empty.xml
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: maestro-android-results
          path: |
            maestro-android-*.xml
            ~/.maestro/tests/**/*.png
            ~/.maestro/tests/**/*.mp4
          retention-days: 30
      
      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: 'maestro-android-*.xml'
          check_name: 'Maestro Android Test Results'

  report-results:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [maestro-ios, maestro-android]
    if: always()
    
    steps:
      - name: Download iOS results
        uses: actions/download-artifact@v4
        with:
          name: maestro-ios-results
          path: ios-results
        continue-on-error: true
      
      - name: Download Android results
        uses: actions/download-artifact@v4
        with:
          name: maestro-android-results
          path: android-results
        continue-on-error: true
      
      - name: Generate summary
        run: |
          echo "## ðŸŽ­ Maestro Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### iOS Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Auth flows: ${{ needs.maestro-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Navigation flows: ${{ needs.maestro-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Payment flows: ${{ needs.maestro-ios.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Android Tests" >> $GITHUB_STEP_SUMMARY
          echo "- Auth flows: ${{ needs.maestro-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Navigation flows: ${{ needs.maestro-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Payment flows: ${{ needs.maestro-android.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¸ Screenshots and videos are available in the artifacts." >> $GITHUB_STEP_SUMMARY

